<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Monetag Earning App</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Monetag Ad Script (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶ï‡ßã‡¶°) -->
    <script src='//libtl.com/sdk.js' data-zone='10235243' data-sdk='show_10235243'></script>

    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #1c1c1e);
            --text-color: var(--tg-theme-text-color, #ffffff);
            --button-color: var(--tg-theme-button-color, #3390ec);
            --button-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: #2c2c2e;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .balance-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .balance-title {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 42px;
            font-weight: 800;
        }

        .coin-icon {
            color: #ffd700;
        }

        .action-btn {
            background-color: var(--button-color);
            color: var(--button-text);
            border: none;
            padding: 18px;
            width: 100%;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .action-btn:active {
            transform: scale(0.96);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loader {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #status {
            margin-top: 10px;
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Balance Section -->
        <div class="balance-card">
            <div class="balance-title">YOUR BALANCE</div>
            <div class="balance-amount"><span class="coin-icon">üíé</span> <span id="balance">0</span></div>
        </div>

        <!-- Action Buttons -->
        <button id="adBtn" class="action-btn" onclick="showRewardedAd()">
            <span>üì∫ Watch Ad & Earn (+100)</span>
            <div class="loader" id="loader"></div>
        </button>
        
        <button class="action-btn" style="background-color: var(--secondary-bg); color: var(--text-color);" onclick="alert('Coming soon!')">
            üöÄ Withdraw Funds
        </button>

        <p id="status">Connecting to server...</p>
    </div>

    <script>
        // 1. CONFIGURATION
        const SUPABASE_URL = 'https://nkzdxxuwylkdkncbshjd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5remR4eHV3eWxrZGtuY2JzaGpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzQwMTIsImV4cCI6MjA3OTY1MDAxMn0.2t-Cn3lL7MbvkNJSrxzx2PheVvuIZNxUIsETFICnvTI'; // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ Key
        
        const REWARD_AMOUNT = 100; // ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡ßá ‡¶ï‡¶§ ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡¶ø‡¶¨‡ßá‡¶®

        // Initialize SDKs
        const tg = window.Telegram.WebApp;
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        tg.expand(); // Full screen

        let currentUser = null;
        let currentBalance = 0;

        // 2. USER LOGIN & DATA FETCH
        async function initApp() {
            const user = tg.initDataUnsafe.user;
            
            // ‡¶ü‡ßá‡¶∏‡ßç‡¶ü‡¶ø‡¶Ç‡ßü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ø‡¶¶‡¶ø ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶ì‡¶™‡ßá‡¶® ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá‡¶® (Optional)
            // const user = { id: 123456, first_name: "Test", username: "testuser" }; 

            if (!user) {
                document.getElementById('status').innerText = "Please open from Telegram.";
                return;
            }

            document.getElementById('status').innerText = `Hello, ${user.first_name}!`;

            // Check if user exists
            let { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();

            if (!data) {
                // New User: Create account
                const { data: newUser, error: insertError } = await supabase
                    .from('users')
                    .insert([
                        { id: user.id, first_name: user.first_name, username: user.username, balance: 0 }
                    ])
                    .select()
                    .single();
                
                if (newUser) {
                    currentUser = newUser;
                    updateUI(newUser.balance);
                }
            } else {
                // Existing User
                currentUser = data;
                updateUI(data.balance);
            }
        }

        function updateUI(balance) {
            currentBalance = balance;
            document.getElementById('balance').innerText = balance;
            document.getElementById('status').innerText = "Ready to earn!";
        }

        // 3. MONETAG AD LOGIC (REWARDED)
        function showRewardedAd() {
            const btn = document.getElementById('adBtn');
            const loader = document.getElementById('loader');
            
            // ‡¶¨‡¶æ‡¶ü‡¶® ‡¶°‡¶ø‡¶∏‡ßá‡¶¨‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶§‡ßá ‡¶¨‡¶æ‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶®‡¶æ ‡¶™‡ßú‡ßá
            btn.disabled = true;
            loader.style.display = 'block';
            document.getElementById('status').innerText = "Loading Ad...";

            // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ Monetag ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
            if (typeof show_10235243 === 'function') {
                show_10235243().then(() => {
                    // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶™‡¶∞
                    document.getElementById('status').innerText = "Ad Watched! Adding reward...";
                    addReward();
                }).catch(e => {
                    // ‡¶Ø‡¶¶‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶≤‡ßã‡¶° ‡¶®‡¶æ ‡¶π‡ßü ‡¶¨‡¶æ ‡¶è‡¶∞‡¶∞ ‡¶¶‡ßá‡ßü
                    console.error(e);
                    alert("Ad failed to load or closed too early. Try again with VPN if allowed.");
                    resetBtn();
                });
            } else {
                alert("Ad script not loaded yet. Check internet connection.");
                resetBtn();
            }
        }

        // 4. ADD REWARD TO DATABASE
        async function addReward() {
            const newBalance = currentBalance + REWARD_AMOUNT;

            const { data, error } = await supabase
                .from('users')
                .update({ balance: newBalance })
                .eq('id', currentUser.id)
                .select()
                .single();

            if (error) {
                alert("Network Error: Could not save balance.");
            } else {
                updateUI(newBalance);
                // Success Vibration (Haptic Feedback)
                tg.HapticFeedback.notificationOccurred('success');
                alert(`Congratulations! You earned ${REWARD_AMOUNT} coins.`);
            }
            resetBtn();
        }

        function resetBtn() {
            const btn = document.getElementById('adBtn');
            const loader = document.getElementById('loader');
            btn.disabled = false;
            loader.style.display = 'none';
        }

        // Start the App
        initApp();

    </script>
</body>
</html>
