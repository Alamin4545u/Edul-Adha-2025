<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Earn Coin App</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.monetag.com/sdk/monetag-sdk-latest.js"></script>
<style>
    * {margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}
    body {background:#0f0c29;color:#fff;min-height:100vh;padding:10px;background:linear-gradient(135deg,#302b63,#0f0c29);}
    .container {max-width:420px;margin:0 auto;}
    .card {background:rgba(255,255,255,0.1);backdrop-filter:blur(12px);border-radius:18px;padding:20px;margin:15px 0;box-shadow:0 10px 30px rgba(0,0,0,0.5);text-align:center;}
    .btn {background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;border:none;padding:16px;border-radius:12px;width:100%;font-size:18px;margin:8px 0;cursor:pointer;box-shadow:0 5px 15px rgba(0,0,0,0.3);}
    .btn:hover {transform:translateY(-3px);}
    .grid {display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .profile {display:flex;align-items:center;gap:15px;margin:20px 0;}
    .profile img {width:70px;height:70px;border-radius:50%;border:4px solid #764ba2;}
    #loading {position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:flex;justify-content:center;align-items:center;z-index:9999;}
    .loader {width:70px;height:70px;border:8px solid #333;border-top:8px solid #764ba2;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin {to{transform:rotate(360deg);}}
    .hidden {display:none !important;}
    .wheel-container {width:300px;height:300px;margin:30px auto;position:relative;}
    .wheel {width:100%;height:100%;border-radius:50%;background:conic-gradient(#ff6b6b 0% 12.5%,#4ecdc4 12.5% 25%,#45b7d1 25% 37.5%,#f9ca24 37.5% 50%,#6c5ce7 50% 62.5%,#fd79a8 62.5% 75%,#fdcb6e 75% 87.5%,#a29bfe 87.5% 100%);transition:transform 5s cubic-bezier(0.17,0.67,0.12,0.99);}
    .arrow {position:absolute;top:-10px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:25px solid transparent;border-right:25px solid transparent;border-bottom:50px solid gold;z-index:10;}
    input, select {width:100%;padding:15px;margin:10px 0;border-radius:12px;border:none;background:rgba(255,255,255,0.1);color:#fff;font-size:16px;}
</style>
</head>
<body>

<div id="loading"><div class="loader"></div></div>

<div class="container hidden" id="app">

    <!-- Dashboard -->
    <div id="dashboard">
        <div class="profile">
            <img id="photo" src="" alt="User">
            <div>
                <h2 id="name">Loading...</h2>
                <p>ID: <span id="tid"></span></p>
            </div>
        </div>
        <div class="card">
            <h2>Balance: <span id="balance">0</span> Coins</h2>
            <h3>Today's Earnings: <span id="today">0</span> Coins</h3>
        </div>
        <div class="grid">
            <button class="btn" onclick="go('spin')">Spin Wheel</button>
            <button class="btn" onclick="offerwall()">Offerwall</button>
            <button class="btn" onclick="go('tasks')">Daily Tasks</button>
            <button class="btn" onclick="go('wallet')">Wallet</button>
            <button class="btn" onclick="go('withdraw')">Withdraw</button>
            <button class="btn" onclick="alert('Referral system coming soon!')">Refer & Earn</button>
        </div>
    </div>

    <!-- Spin Page -->
    <div id="spin" class="hidden">
        <button class="btn" onclick="go('dashboard')">Back to Home</button>
        <div class="card">
            <h2>Spin & Win Up to 500 Coins!</h2>
            <div class="wheel-container">
                <div class="arrow"></div>
                <div id="wheel" class="wheel"></div>
            </div>
            <p id="spinText">You have 1 free spin today!</p>
            <button class="btn" id="spinBtn" onclick="spinNow()">SPIN NOW</button>
            <button class="btn" onclick="adForSpin()">Watch Ad = Extra Spin</button>
        </div>
    </div>

    <!-- Tasks -->
    <div id="tasks" class="hidden">
        <button class="btn" onclick="go('dashboard')">Back</button>
        <div class="card">
            <h2>Complete Tasks & Earn</h2>
            <div id="taskList"></div>
        </div>
    </div>

    <!-- Wallet -->
    <div id="wallet" class="hidden">
        <button class="btn" onclick="go('dashboard')">Back</button>
        <div class="card">
            <h2>Total Balance: <span id="wbalance">0</span> Coins</h2>
            <button class="btn" onclick="go('withdraw')">Withdraw Now</button>
        </div>
    </div>

    <!-- Withdraw -->
    <div id="withdraw" class="hidden">
        <button class="btn" onclick="go('wallet')">Back</button>
        <div class="card">
            <h2>Withdraw Money</h2>
            <input type="number" id="amount" placeholder="Enter Amount (Min 200)">
            <select id="method">
                <option>Bkash</option>
                <option>Nagad</option>
                <option>Rocket</option>
            </select>
            <button class="btn" onclick="sendWithdraw()">Submit Request</button>
        </div>
    </div>

</div>

<script>
// Supabase Config
const supabase = window.supabase.createClient(
    'https://nkzdxxuwylkdkncbshjd.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInZlciI6MCwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzQwMTIsImV4cCI6MjA3OTY1MDAxMn0.2t-Cn3lL7MbvkNJSrxzx2PheVvuIZNxUIsETFICnvTI'
);

let user = null;
let tg = window.Telegram?.WebApp;
if(tg) tg.ready();

const prizes = [10, 25, 0, 50, 100, 5, 200, 0];
let canSpinToday = true;
let extraSpin = false;

const tasks = [
    {id:1, name:"Watch Video Ad", reward:15},
    {id:2, name:"Complete Offer", reward:30},
    {id:3, name:"Daily Login Bonus", reward:10},
    {id:4, name:"Invite 1 Friend", reward:100},
    {id:5, name:"Rate Our App", reward:20}
];

async function startApp() {
    try {
        const telegramId = tg?.initDataUnsafe?.user?.id || 123456789;
        const name = tg?.initDataUnsafe?.user?.first_name || "User";
        const photo = tg?.initDataUnsafe?.user?.photo_url || "";

        let {data} = await supabase.from('users').select('*').eq('telegram_id', telegramId);
        
        if(!data || data.length === 0) {
            await supabase.from('users').insert({
                telegram_id: telegramId,
                name: name,
                photo_url: photo,
                balance: 50,
                today_earnings: 0
            });
            user = {telegram_id:telegramId, name, photo_url:photo, balance:50, today_earnings:0};
        } else {
            user = data[0];
        }

        // Update UI
        document.getElementById('photo').src = photo || 'https://via.placeholder.com/70';
        document.getElementById('name').innerText = user.name || "User";
        document.getElementById('tid').innerText = telegramId;
        document.getElementById('balance').innerText = user.balance || 0;
        document.getElementById('today').innerText = user.today_earnings || 0;
        document.getElementById('wbalance').innerText = user.balance || 0;

        loadTasks();

        // Hide loading
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');

    } catch(e) {
        alert("Connection Error. Check internet.");
        console.error(e);
    }
}

function go(page) {
    document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
    document.getElementById(page).classList.remove('hidden');
    if(page === 'tasks') loadTasks();
}

async function addCoins(amount, reason = "task") {
    user.balance += amount;
    user.today_earnings = (user.today_earnings || 0) + amount;
    await supabase.from('users').update({
        balance: user.balance,
        today_earnings: user.today_earnings
    }).eq('telegram_id', user.telegram_id);

    document.getElementById('balance').innerText = user.balance;
    document.getElementById('today').innerText = user.today_earnings;
    document.getElementById('wbalance').innerText = user.balance;
}

// Ads
function offerwall() {
    show_10235243('pop').then(() => {
        addCoins(30);
        alert("30 Coins Added!");
    }).catch(() => {});
}

function adForSpin() {
    show_10235243().then(() => {
        extraSpin = true;
        alert("Extra Spin Unlocked!");
        document.getElementById('spinBtn').disabled = false;
    });
}

function spinNow() {
    if(!canSpinToday && !extraSpin) return alert("No spins left today!");
    
    document.getElementById('spinBtn').disabled = true;
    const deg = 1800 + Math.floor(Math.random() * 360);
    document.getElementById('wheel').style.transform = `rotate(${deg}deg)`;

    setTimeout(() => {
        const win = prizes[Math.floor(Math.random() * prizes.length)];
        alert(`You Won ${win} Coins!`);
        if(win > 0) addCoins(win, "spin");
        if(!extraSpin) canSpinToday = false;
        extraSpin = false;
        document.getElementById('spinBtn').disabled = false;
    }, 5000);
}

function loadTasks() {
    const list = document.getElementById('taskList');
    list.innerHTML = '';
    tasks.forEach(t => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.innerHTML = `\( {t.name} â†’ + \){t.reward} Coins`;
        btn.onclick = () => {
            show_10235243().then(() => {
                addCoins(t.reward);
                btn.innerHTML = 'Completed';
                btn.disabled = true;
            });
        };
        list.appendChild(btn);
    });
}

async function sendWithdraw() {
    const amt = parseInt(document.getElementById('amount').value);
    if(!amt || amt < 200 || amt > user.balance) {
        alert("Minimum 200 Coins & sufficient balance required!");
        return;
    }
    await supabase.from('withdraw_requests').insert({
        user_id: user.telegram_id,
        amount: amt,
        method: document.getElementById('method').value
    });
    user.balance -= amt;
    await supabase.from('users').update({balance: user.balance}).eq('telegram_id', user.telegram_id);
    alert("Withdraw Request Sent! Will be processed in 24-48 hours.");
    go('dashboard');
}

// Start App
startApp();
</script>
</body>
</html>
