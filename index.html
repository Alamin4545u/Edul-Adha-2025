<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Earning App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #181818; color: #fff; font-family: sans-serif; padding: 20px; text-align: center; }
        .card { background: #242424; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-primary { background: #5865F2; color: white; }
        .btn-success { background: #00b894; color: white; }
        input, select { width: 100%; padding: 10px; margin-bottom: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 5px; box-sizing: border-box;}
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="card">
        <h3>Balance: <span id="balance">0</span> Coins</h3>
        <small id="username">Loading...</small>
    </div>

    <!-- Menu -->
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="showSection('tasks')">Tasks</button>
        <button class="btn btn-success" onclick="showSection('withdraw')">Withdraw</button>
    </div>

    <!-- Tasks Section -->
    <div id="tasks" class="section">
        <h3>Available Tasks</h3>
        <div id="taskList">Loading...</div>
    </div>

    <!-- Withdraw Section -->
    <div id="withdraw" class="section hidden">
        <h3>Request Payment</h3>
        <div class="card">
            <p>Rate: 1000 Coins = <span id="rate">...</span></p>
            <input type="number" id="wdAmount" placeholder="Amount (Points)">
            <select id="wdMethod">
                <option value="bkash">Bkash</option>
                <option value="nagad">Nagad</option>
                <option value="binance">Binance</option>
            </select>
            <input type="text" id="wdAddress" placeholder="Wallet Number">
            <button class="btn btn-success" onclick="requestWithdraw()">Submit Request</button>
        </div>
        <h4>History</h4>
        <div id="wdHistory"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nkzdxxuwylkdkncbshjd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5remR4eHV3eWxrZGtuY2JzaGpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzQwMTIsImV4cCI6MjA3OTY1MDAxMn0.2t-Cn3lL7MbvkNJSrxzx2PheVvuIZNxUIsETFICnvTI';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const tg = window.Telegram.WebApp;
        tg.expand();

        let user = tg.initDataUnsafe.user;
        let dbUser = null;
        let settings = {};

        // For Testing in Browser (Uncomment to test without Telegram)
        // user = { id: 12345678, first_name: "Test", username: "User" };

        async function init() {
            if (!user) return document.body.innerHTML = "<h1>Please open in Telegram</h1>";
            
            // 1. Login/Register
            let { data } = await supabase.from('users').select('*').eq('id', user.id).single();
            if (!data) {
                const { data: newUser } = await supabase.from('users').insert([{ id: user.id, first_name: user.first_name, username: user.username }]).select().single();
                dbUser = newUser;
            } else {
                dbUser = data;
            }

            if(dbUser.is_banned) return document.body.innerHTML = "<h1 style='color:red'>You are BANNED</h1>";

            // 2. Load Data
            document.getElementById('username').innerText = "@" + (dbUser.username || 'user');
            document.getElementById('balance').innerText = dbUser.balance;
            
            loadSettings();
            loadTasks();
            loadHistory();
        }

        // --- TASKS & ADS ---
        async function loadTasks() {
            const { data: tasks } = await supabase.from('tasks').select('*').eq('is_active', true);
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            
            tasks.forEach(task => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.innerHTML = `${task.title} (+${task.reward})`;
                btn.onclick = () => playAd(task.zone_id, task.reward);
                list.appendChild(btn);
            });
        }

        function playAd(zoneId, reward) {
            // Remove old script
            const old = document.getElementById('ad-script');
            if(old) old.remove();

            // Inject new script
            const script = document.createElement('script');
            script.src = '//libtl.com/sdk.js';
            script.id = 'ad-script';
            script.dataset.zone = zoneId;
            script.dataset.sdk = `show_${zoneId}`;
            
            document.body.appendChild(script);

            script.onload = () => {
                const sdkFunc = window[`show_${zoneId}`];
                if (typeof sdkFunc === 'function') {
                    sdkFunc().then(() => {
                        giveReward(reward);
                    });
                } else {
                    alert("Ad failed. Use VPN (USA/UK).");
                }
            };
            script.onerror = () => alert("Network Error. Check VPN.");
        }

        async function giveReward(amount) {
            const newBal = dbUser.balance + amount;
            await supabase.from('users').update({ balance: newBal, ads_watched: dbUser.ads_watched + 1 }).eq('id', user.id);
            dbUser.balance = newBal;
            document.getElementById('balance').innerText = newBal;
            alert(`You earned ${amount} coins!`);
        }

        // --- WITHDRAW ---
        async function loadSettings() {
            const { data } = await supabase.from('app_settings').select('*');
            data.forEach(s => settings[s.key] = s.value);
            document.getElementById('rate').innerText = `${settings.currency_symbol}${settings.conversion_rate}`;
        }

        async function requestWithdraw() {
            const amount = parseInt(document.getElementById('wdAmount').value);
            const method = document.getElementById('wdMethod').value;
            const address = document.getElementById('wdAddress').value;
            const minWd = parseInt(settings.min_withdraw);

            if (amount < minWd) return alert(`Minimum ${minWd} points required.`);
            if (amount > dbUser.balance) return alert("Insufficient balance.");
            if (!address) return alert("Enter wallet address.");

            const money = ((amount / 1000) * parseFloat(settings.conversion_rate)).toFixed(2);
            
            // Deduct & Insert
            await supabase.from('users').update({ balance: dbUser.balance - amount }).eq('id', user.id);
            await supabase.from('withdrawals').insert([{
                user_id: user.id, amount_points: amount, amount_money: `${settings.currency_symbol}${money}`, method, wallet_address: address
            }]);

            dbUser.balance -= amount;
            document.getElementById('balance').innerText = dbUser.balance;
            alert("Withdrawal submitted!");
            loadHistory();
        }

        async function loadHistory() {
            const { data } = await supabase.from('withdrawals').select('*').eq('user_id', user.id).order('created_at', {ascending:false});
            const div = document.getElementById('wdHistory');
            div.innerHTML = data.map(w => `<div class="card" style="padding:10px; font-size:12px;">${w.amount_money} - ${w.status.toUpperCase()}</div>`).join('');
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(d => d.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        init();
    </script>
</body>
</html>
