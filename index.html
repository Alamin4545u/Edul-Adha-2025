<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bkash Earn App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons (For icons like Home, Wallet, Tasks, etc.) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --tg-theme-bg: #1e1e1e; /* Telegram Mini App Background */
            --tg-theme-text: #ffffff; /* Telegram Mini App Text */
            --tg-theme-link: #4da7ff; /* Telegram Mini App Link/Accent */
            --tg-theme-hint: #888888; /* Telegram Mini App Hint */
            --tg-theme-button: #4da7ff; /* Telegram Mini App Button */
            --tg-theme-button-text: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-theme-bg);
            color: var(--tg-theme-text);
            padding-bottom: 72px; /* For fixed navbar */
            overflow-x: hidden;
            user-select: none;
        }
        
        /* Custom Styles for App UI */
        .card {
            background-color: #2c2c2c;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .screen {
            display: none;
            padding: 16px;
        }
        .screen.active {
            display: block;
        }

        .nav-btn {
            color: var(--tg-theme-hint);
            transition: color 0.2s;
        }
        .nav-btn.active {
            color: var(--tg-theme-link);
        }

        .action-button {
            transition: transform 0.1s ease-in-out, background-color 0.1s;
        }
        .action-button:active {
            transform: scale(0.95);
        }

        /* --- Spin Wheel Specific Styles --- */
        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto;
        }

        .wheel-svg-wrapper {
            width: 100%;
            height: 100%;
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .wheel-pointer {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 40px;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            background-color: var(--tg-theme-button);
            z-index: 10;
        }
        
        /* --- Quiz Styles --- */
        .quiz-option {
            background-color: #383838;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .quiz-option:hover {
            background-color: #444444;
        }
        .quiz-option.selected {
            border-color: var(--tg-theme-link);
            background-color: #3d4a5c;
        }

        /* --- Task Styles --- */
        .task-item {
            cursor: pointer;
            margin-bottom: 12px;
            padding: 12px;
            background-color: #2c2c2c;
            border-radius: 8px;
            transition: background-color 0.2s;
            border: 1px solid #383838;
        }
        .task-item:hover {
            background-color: #383838;
        }
        .task-item.completed {
            opacity: 0.6;
            background-color: #1e1e1e;
            border: 1px solid #43a047;
            pointer-events: none;
        }
        .task-item.completed .task-title::after {
            content: ' ✓';
            color: #43a047;
            font-weight: bold;
        }
        .task-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-reward {
            font-weight: bold;
            color: #fdd835;
        }
    </style>
</head>
<body>

<!-- Header (Fixed at Top) -->
<header class="card p-3 flex justify-between items-center fixed top-0 left-0 right-0 z-20 rounded-b-none">
    <div class="flex items-center space-x-3">
        <div id="profilePic" class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center text-lg font-bold text-white shadow-lg">?</div>
        <div>
            <div id="headerFullName" class="text-white font-semibold">লোড হচ্ছে...</div>
            <div id="headerUsername" class="text-sm text-gray-400">@username</div>
        </div>
    </div>
    <div class="text-right">
        <div class="text-sm text-gray-400">আপনার ব্যালেন্স</div>
        <div id="headerBalance" class="text-xl font-bold text-green-400">৳ 0.00</div>
    </div>
</header>

<!-- Main Content Area -->
<div class="pt-20">
    <!-- Home Screen -->
    <div id="home-screen" class="screen active">
        <div class="grid grid-cols-2 gap-4">
            <!-- Daily Check -->
            <button id="dailyCheckinBtn" class="action-button card p-4 flex flex-col items-center justify-center h-28 bg-green-700 hover:bg-green-600 transition-colors">
                <i data-lucide="calendar-check" class="w-8 h-8 mb-2 text-white"></i>
                <span class="text-white font-semibold">Daily Check</span>
            </button>
            
            <!-- Spin Wheel -->
            <button id="spinWheelBtn" class="action-button card p-4 flex flex-col items-center justify-center h-28 bg-red-700 hover:bg-red-600 transition-colors">
                <i data-lucide="gauge" class="w-8 h-8 mb-2 text-white"></i>
                <span class="text-white font-semibold">Spin Wheel</span>
            </button>

             <!-- Quiz -->
            <button id="quizBtn" class="action-button card p-4 flex flex-col items-center justify-center h-28 bg-yellow-600 hover:bg-yellow-500 transition-colors">
                <i data-lucide="help-circle" class="w-8 h-8 mb-2 text-white"></i>
                <span class="text-white font-semibold">কুইজ</span>
            </button>
            
            <!-- Placeholder Card -->
            <div class="card p-4 flex flex-col items-center justify-center h-28 opacity-50">
                <i data-lucide="zap" class="w-8 h-8 mb-2 text-gray-400"></i>
                <span class="text-gray-400 font-semibold">নতুন ইভেন্ট</span>
            </div>
        </div>

        <div class="mt-6 p-4 card">
            <h2 class="text-lg font-bold border-b border-gray-600 pb-2 mb-2">বিশেষ ঘোষণা</h2>
            <p class="text-sm text-gray-400">গুরুত্বপূর্ণ: কোনো প্রকার অটো ক্লিকার বা বট ব্যবহার করবেন না। ব্যবহার করলে অ্যাকাউন্ট সাসপেন্ড হতে পারে। প্রতিদিন অ্যাপটি ভিজিট করুন এবং নতুন টাস্কের জন্য অপেক্ষা করুন।</p>
        </div>
    </div>

    <!-- Task Screen -->
    <div id="task-screen" class="screen">
        <h2 class="text-2xl font-bold mb-4">টাস্ক</h2>
        <div id="task-list" class="space-y-3">
            <p class="text-gray-400">টাস্ক লোড হচ্ছে...</p>
        </div>
    </div>

    <!-- Spin Wheel Screen -->
    <div id="spin-screen" class="screen">
        <button id="spinBackBtn" class="text-blue-500 flex items-center mb-4">
            <i data-lucide="arrow-left" class="w-5 h-5 mr-1"></i> ফিরে যান
        </button>
        <h2 class="text-2xl font-bold mb-6 text-center">স্পিন হুইল</h2>
        
        <div class="flex justify-center mb-4">
            <span class="card px-4 py-2 text-lg font-semibold text-yellow-400">স্পিন বাকি: <span id="spinsLeft">0</span></span>
        </div>

        <div class="wheel-container">
            <div class="wheel-pointer"></div>
            <svg viewBox="0 0 500 500" class="wheel-svg-wrapper" id="wheelGroup">
                <!-- SVG segments will be injected by JavaScript -->
                <circle cx="250" cy="250" r="210" fill="none" stroke="#5d4037" stroke-width="20"></circle>
                <circle cx="250" cy="250" r="10" fill="#fdd835"></circle>
            </svg>
        </div>

        <div class="text-center mt-8">
            <button id="spinTriggerBtn" class="action-button bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-full shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                বিজ্ঞাপন দেখুন ও স্পিন করুন
            </button>
        </div>
    </div>
    
    <!-- Quiz Screen -->
    <div id="quiz-screen" class="screen">
        <button id="quizBackBtn" class="text-blue-500 flex items-center mb-4">
            <i data-lucide="arrow-left" class="w-5 h-5 mr-1"></i> ফিরে যান
        </button>
        <h2 class="text-2xl font-bold mb-4">কুইজ সেশন</h2>

        <!-- Progress Bar -->
        <div class="card p-3 mb-4">
            <div id="quiz-progress-text" class="text-sm text-gray-400 mb-1">দৈনিক কুইজ সেশন বাকি আছে: 0</div>
            <div class="bg-gray-700 rounded-full h-2.5">
                <div id="quiz-progress-inner" class="bg-green-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="quiz-step-text" class="text-xs text-right mt-1 font-semibold">ধাপ: 0/3</div>
        </div>

        <!-- Quiz Area -->
        <div class="card p-4">
            <p id="quiz-instruction" class="text-yellow-400 font-semibold mb-3">সঠিক উত্তর দিয়ে পরবর্তী ধাপে যান</p>
            <h3 id="quiz-question-text" class="text-lg font-bold mb-4">প্রশ্ন লোড হচ্ছে...</h3>
            <div id="quiz-options-container" class="space-y-2">
                <!-- Options injected here -->
            </div>
            <div class="text-center mt-6">
                <button id="next-quiz-btn" disabled class="action-button bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    পরবর্তী কুইজ
                </button>
            </div>
        </div>
    </div>


    <!-- Wallet Screen -->
    <div id="wallet-screen" class="screen">
        <h2 class="text-2xl font-bold mb-4">ওয়ালেট ও উইথড্র</h2>
        <div class="card p-4 mb-6 text-center">
            <p class="text-gray-400 text-sm">বর্তমান ব্যালেন্স</p>
            <p id="withdrawBalance" class="text-3xl font-extrabold text-green-400">৳ 0.00</p>
            <p class="text-gray-400 text-xs mt-1">ন্যূনতম উইথড্র: ৳ 10.00</p>
        </div>

        <div class="card p-4">
            <h3 class="text-xl font-bold mb-3 border-b border-gray-600 pb-2">উইথড্রল ফর্ম</h3>
            <div id="payment-method-container" class="space-y-3">
                <!-- Payment methods and form elements injected here -->
                <p>পেমেন্ট পদ্ধতি লোড হচ্ছে...</p>
            </div>
            
            <div class="mt-6 text-center">
                <button id="submitWithdrawBtn" disabled class="action-button bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-8 rounded-full shadow-lg disabled:opacity-50 disabled:cursor-not-allowed w-full">
                    উইথড্র সাবমিট করুন
                </button>
            </div>
        </div>
    </div>

    <!-- Affiliate Screen -->
    <div id="refer-screen" class="screen">
        <h2 class="text-2xl font-bold mb-4">অ্যাফিলিয়েট / রেফার</h2>

        <div class="card p-4 mb-4">
            <h3 class="text-xl font-bold mb-2">রেফারেল স্ট্যাটাস</h3>
            <p id="referral-notice" class="text-sm text-yellow-400 mb-3">প্রতি সফল রেফারে আপনি পাবেন ৳5.00! অ্যাফিলিয়েট কমিশন: 10%।</p>
            
            <div class="flex justify-between border-t border-gray-600 pt-3">
                <div>
                    <p class="text-gray-400 text-sm">মোট রেফারেল</p>
                    <p id="referral-count" class="text-2xl font-bold text-white">0</p>
                </div>
                <div class="text-right">
                    <p class="text-gray-400 text-sm">মোট রেফারেল আর্নিং</p>
                    <p id="referral-earnings" class="text-2xl font-bold text-green-400">৳ 0.00</p>
                </div>
            </div>
        </div>

        <div class="card p-4">
            <h3 class="text-xl font-bold mb-2">আপনার রেফারেল লিংক</h3>
            <input id="referralLink" type="text" readonly class="w-full p-2 card bg-gray-700 text-white rounded-lg mb-3 border border-gray-600" value="https://t.me/yourbot?start=code">
            <button id="shareReferralBtn" class="action-button bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg w-full">
                <i data-lucide="share-2" class="w-5 h-5 inline-block mr-2"></i> লিংক শেয়ার করুন
            </button>
        </div>
    </div>

</div>

<!-- Fixed Navigation Bar -->
<nav class="fixed bottom-0 left-0 right-0 card flex justify-around p-3 z-20 rounded-t-none border-t border-gray-700">
    <button class="nav-btn active flex flex-col items-center" data-screen="home-screen">
        <i data-lucide="home" class="w-6 h-6"></i>
        <span class="text-xs">হোম</span>
    </button>
    <button class="nav-btn flex flex-col items-center" data-screen="task-screen">
        <i data-lucide="list-checks" class="w-6 h-6"></i>
        <span class="text-xs">টাস্ক</span>
    </button>
    <button class="nav-btn flex flex-col items-center" data-screen="wallet-screen">
        <i data-lucide="wallet" class="w-6 h-6"></i>
        <span class="text-xs">ওয়ালেট</span>
    </button>
    <button class="nav-btn flex flex-col items-center" data-screen="refer-screen">
        <i data-lucide="users" class="w-6 h-6"></i>
        <span class="text-xs">অ্যাফিলিয়েট</span>
    </button>
</nav>

<!-- JavaScript Logic -->
<script>
    // Lucide icons setup (renders icons on load)
    lucide.createIcons();
</script>

<script>
    // --- IMPORTANT: DUMMY AD FUNCTION (আপনার Giga কোড এখানে প্রতিস্থাপন করুন) ---
    // এই ফাংশনটি ছাড়া Daily Check, Spin, Quiz-এর অ্যাড টাস্ক কাজ করবে না।
    window.showGiga = function() {
        return new Promise((resolve, reject) => {
            console.log("Ad function called: Simulating 2 seconds delay.");
            // আপনার Giga Ad Network কোড এখানে যোগ করুন
            // ... [এখানে Giga Ad Integration Code] ...
            
            // সফল হলে resolve() কল করুন
            setTimeout(() => {
                resolve();
            }, 2000); // 2 সেকেন্ড ধরে অ্যাড দেখানোর সিমুলেশন
            
            // যদি অ্যাড লোড করতে সমস্যা হয়, reject() কল করুন।
            // reject(new Error("Ad failed to load"));
        });
    };

    // --- APP JAVASCRIPT LOGIC START ---
    
    // মনে রাখবেন: Supabase URL এবং Key অবশ্যই পরিবর্তন করতে হবে।
    const supabaseUrl = "https://fwikhcittcaadwziitdv.supabase.co"; // <-- আপনার URL দিন
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3aWtoY2l0dGNhYWR3emlpdGR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMzY0MjIsImV4cCI6MjA3ODcxMjQyMn0.wLBcy29HNFPZ5dRzJ11CaIjD_zQvBi3vNLE66HlI2es"; // <-- আপনার ANON Key দিন
    const BOT_USERNAME = "Bkash_earn_free_TkBot"; // <-- আপনার টেলিগ্রাম বটের ইউজারনেম দিন

    const { createClient } = supabase;
    const supabaseClient = createClient(supabaseUrl, supabaseKey);
    const sb = supabaseClient; // Alias for simplicity
    let tg; // Fix: Declared globally with 'let', will be assigned inside main()

    // --- Constants & Global Variables ---
    const MINIMUM_WITHDRAW_AMOUNT = 10;
    let appConfig = { dailyReward: 1, dailyCheckinLimit: 1, referralBonus: 5, affiliateCommissionRate: 0.1 };
    let spinConfig = { dailyLimit: 5, rewards: [0.5, 1, 2, 0.5, 1.5, 1, 0.5, 2, 1, 1.5] };
    let quizConfig = { dailyLimit: 3, reward: 2, clickTarget: 3 };
    let paymentMethods = [];
    let telegramUser, userData = {};
    let supabaseUid = null;
    let isSpinning = false;
    let currentRotation = 0;
    let quizQuestions = [];
    let currentQuizIndex = 0;
    let selectedQuizOption = null;
    let adClicked = false;

    // --- UI Elements ---
    const screens = document.querySelectorAll('.screen');
    const navButtons = document.querySelectorAll('.nav-btn');
    const headerElements = { pic: document.getElementById('profilePic'), fullName: document.getElementById('headerFullName'), username: document.getElementById('headerUsername'), balance: document.getElementById('headerBalance') };
    const homeButtons = { dailyCheckin: document.getElementById('dailyCheckinBtn'), spin: document.getElementById('spinWheelBtn'), quiz: document.getElementById('quizBtn') };
    const spinScreenElements = { backBtn: document.getElementById('spinBackBtn'), triggerBtn: document.getElementById('spinTriggerBtn'), spinsLeft: document.getElementById('spinsLeft'), wheelGroup: document.getElementById('wheelGroup') };
    const walletElements = { balance: document.getElementById('withdrawBalance'), submitBtn: document.getElementById('submitWithdrawBtn'), paymentContainer: document.getElementById('payment-method-container') };
    const referElements = { linkInput: document.getElementById('referralLink'), shareBtn: document.getElementById('shareReferralBtn'), notice: document.getElementById('referral-notice'), count: document.getElementById('referral-count'), earnings: document.getElementById('referral-earnings') };
    const taskListContainer = document.getElementById('task-list');
    const quizScreenElements = { backBtn: document.getElementById('quizBackBtn'), progressText: document.getElementById('quiz-progress-text'), stepText: document.getElementById('quiz-step-text'), progressInner: document.getElementById('quiz-progress-inner'), instruction: document.getElementById('quiz-instruction'), questionText: document.getElementById('quiz-question-text'), optionsContainer: document.getElementById('quiz-options-container'), nextBtn: document.getElementById('next-quiz-btn') };

    // --- Main Logic ---
    function main() {
        // Fix applied here: Check for window.Telegram before accessing WebApp
        if (typeof window.Telegram === 'undefined' || typeof window.Telegram.WebApp === 'undefined') {
            document.body.innerHTML = "<h1 class='text-center mt-20 text-red-500'>ত্রুটি: এটি একটি টেলিগ্রাম মিনি অ্যাপ। অনুগ্রহ করে টেলিগ্রাম অ্যাপের ভিতর থেকে খুলুন।</h1>";
            return;
        }
        
        tg = window.Telegram.WebApp; // Assignment moved inside to ensure window.Telegram is available

        tg.ready();
        tg.expand();

        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            telegramUser = tg.initDataUnsafe.user;
            // Supabase Anon Sign-in (required for RLS based on auth.uid())
            sb.auth.signInAnonymously()
                .then(({ data, error }) => {
                    if (error) {
                        handleError("ব্যবহারকারী যাচাইকরণে সমস্যা হয়েছে। অনুগ্রহ করে অ্যাপটি রিস্টার্ট করুন।", error);
                        return;
                    }
                    if (data && data.user) {
                        supabaseUid = data.user.id;
                        initializeApp();
                    } else {
                        handleError("Supabase থেকে ব্যবহারকারীর ডেটা পাওয়া যায়নি।");
                    }
                })
                .catch(e => {
                     handleError("Supabase সংযোগ ব্যর্থ।", e);
                });
        } else {
            document.body.innerHTML = "<h1 class='text-center mt-20 text-red-500'>অনুগ্রহ করে টেলিগ্রাম অ্যাপ থেকে খুলুন।</h1>";
        }
    }

    async function initializeApp() {
        try {
            await fetchAdminSettings();
            setupEventListeners();
            createSvgWheel();
            await fetchUserData();
            setupSubscription();
            // Initial screen rendering after data load
            showScreen('home-screen'); 
            lucide.createIcons();
        } catch (error) {
            handleError("অ্যাপ চালু করতে সমস্যা হয়েছে।", error);
        }
    }

    async function fetchUserData() {
        const today = new Date().toISOString().slice(0, 10);
        const userId = telegramUser.id.toString();

        try {
            const { data: user, error: fetchError } = await sb.from('users').select('*').eq('id', userId).single();

            if (fetchError && fetchError.message !== 'JSON object requested, multiple (or no) rows returned') {
                throw fetchError;
            }

            if (user) {
                // ব্যবহারকারী থাকলে, তার ডেটা আপডেট করুন (দৈনিক রিসেট চেক সহ)
                userData = {
                    ...user,
                    checkinsToday: user.checkinsToday?.date === today ? user.checkinsToday : { date: today, count: 0 },
                    spinsToday: user.spinsToday?.date === today ? user.spinsToday : { date: today, count: 0 },
                    quizProgress: user.quizProgress?.date === today ? user.quizProgress : { date: today, completedToday: 0, currentStep: 0 },
                    referrals: user.referrals ?? [],
                    completedTasks: user.completedTasks ?? []
                };
            } else {
                // নতুন ব্যবহারকারী তৈরি করুন
                const referrerId = tg.initDataUnsafe.start_param;
                const newUser = {
                    id: userId,
                    telegramId: userId,
                    username: telegramUser.username || '',
                    fullName: `${telegramUser.first_name || ''} ${telegramUser.last_name || ''}`.trim(),
                    balance: 0,
                    checkinsToday: { date: today, count: 0 },
                    spinsToday: { date: today, count: 0 },
                    completedTasks: [],
                    quizProgress: { date: today, completedToday: 0, currentStep: 0 },
                    referredBy: referrerId || null,
                    referrals: [],
                    referralEarnings: 0,
                    affiliateCode: generateUniqueAffiliateCode(telegramUser.username || telegramUser.id.toString()),
                    createdAt: new Date().toISOString(),
                    uid: supabaseUid
                };
                const { error: insertError } = await sb.from('users').insert(newUser);
                if (insertError) {
                    throw insertError;
                }
                userData = newUser;
                if (referrerId && referrerId !== newUser.affiliateCode) {
                    await handleAffiliateSignup(referrerId, newUser.id);
                }
            }
            updateUI();
        } catch (error) {
            console.error("Supabase fetch/insert error:", error);
            handleError("ব্যবহারকারীর ডেটা লোড করতে ব্যর্থ হয়েছে। আপনার ইন্টারনেট সংযোগ পরীক্ষা করুন।");
        }
    }

    function setupSubscription() {
        const userId = telegramUser.id.toString();
        try {
            sb.channel('user-updates')
              .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'users',
                    filter: `id=eq.${userId}`
                }, payload => {
                    // নতুন ডেটা দিয়ে লোকাল 'userData' আপডেট করুন
                    userData = {
                        ...userData, 
                        ...payload.new 
                    };
                    updateUI();
                })
              .subscribe((status, err) => {
                    if (err) console.error("Subscription error:", err);
                });
        } catch (error) {
            console.error("Subscription setup failed:", error);
        }
    }

    async function fetchAdminSettings() {
        try {
            const { data: settings, error } = await sb.from('settings').select('*');
            if (error) throw error;

            const getSetting = (id, defaultConfig) => {
                const doc = settings.find(s => s.id === id);
                return doc ? { ...defaultConfig, ...(doc.config || {}) } : defaultConfig;
            };

            appConfig = getSetting('appConfig', appConfig);
            spinConfig = getSetting('spinConfig', spinConfig);
            quizConfig = getSetting('quizConfig', { ...quizConfig, clickTarget: quizConfig.clickTarget || 3 }); 

            const paymentMethodsDoc = settings.find(s => s.id === 'paymentMethods');
            if (paymentMethodsDoc && paymentMethodsDoc.config?.methods) {
                paymentMethods = paymentMethodsDoc.config.methods.filter(method => method.enabled);
            }

            updateWalletUI();
        } catch (error) {
            handleError("অ্যাপ সেটিংস লোড করা যায়নি।", error);
        }
    }

    function updateUI() {
        if (!userData || !telegramUser) return; 

        const balance = userData.balance ?? 0;
        const fullName = userData.fullName || telegramUser.first_name || 'ব্যবহারকারী';
        const username = userData.username || telegramUser.id;
        const formattedBalance = `৳ ${balance.toFixed(2)}`;

        headerElements.balance.innerText = formattedBalance;
        headerElements.fullName.innerText = fullName;
        headerElements.username.innerText = username ? `@${username}` : `#${telegramUser.id}`;
        headerElements.pic.innerText = getInitials(fullName);

        walletElements.balance.innerText = formattedBalance;
        const canWithdraw = balance >= MINIMUM_WITHDRAW_AMOUNT;
        walletElements.submitBtn.disabled = !canWithdraw;
        walletElements.submitBtn.innerText = canWithdraw ? "উইথড্র সাবমিট করুন" : `ন্যূনতম ৳${MINIMUM_WITHDRAW_AMOUNT} প্রয়োজন`;

        referElements.notice.textContent = `প্রতি সফল রেফারে আপনি পাবেন ৳${(appConfig.referralBonus ?? 0).toFixed(2)}! অ্যাফিলিয়েট কমিশন: ${((appConfig.affiliateCommissionRate ?? 0) * 100).toFixed(0)}%`;
        referElements.linkInput.value = `https://t.me/${BOT_USERNAME}?start=${userData.affiliateCode || telegramUser.id}`;
        
        const today = new Date().toISOString().slice(0, 10);
        const spinsTodayCount = userData.spinsToday?.date === today ? (userData.spinsToday?.count ?? 0) : 0;
        const spinsLeftCount = spinConfig.dailyLimit - spinsTodayCount;
        spinScreenElements.spinsLeft.innerText = spinsLeftCount > 0 ? spinsLeftCount : 0;

        if (referElements.count) {
            referElements.count.textContent = userData.referrals?.length ?? 0;
        }
        if (referElements.earnings) {
            referElements.earnings.textContent = `৳ ${(userData.referralEarnings ?? 0).toFixed(2)}`;
        }

        if (document.getElementById('quiz-screen').classList.contains('active')) {
            displayCurrentQuiz();
        }
    }

    function updateWalletUI() {
        const container = walletElements.paymentContainer;
        if (!container) return; 
        
        container.innerHTML = '';
        if (paymentMethods.length === 0) {
            container.innerHTML = '<p class="text-gray-400">কোনো পেমেন্ট পদ্ধতি উপলব্ধ নেই।</p>';
            return;
        }

        container.innerHTML = `
            <label for="paymentMethodSelect" class="block text-sm font-medium mb-1">পেমেন্ট পদ্ধতি নির্বাচন করুন:</label>
            <select id="paymentMethodSelect" class="w-full p-2 card bg-gray-700 text-white rounded-lg mb-3 border border-gray-600">
                ${paymentMethods.map(method => `<option value="${method.id}">${method.name}</option>`).join('')}
            </select>
            <label for="accountNumberInput" id="accountNumberLabel" class="block text-sm font-medium mb-1"></label>
            <input type="text" id="accountNumberInput" class="w-full p-2 card bg-gray-700 text-white rounded-lg border border-gray-600">
        `;

        const select = document.getElementById('paymentMethodSelect');
        const input = document.getElementById('accountNumberInput');
        const label = document.getElementById('accountNumberLabel');

        const updateInputForMethod = () => {
            if (!select || !input || !label) return;
            const selectedMethod = paymentMethods.find(m => m.id === select.value);
            if (selectedMethod) {
                label.textContent = `আপনার ${selectedMethod.name} নম্বর দিন:`;
                input.placeholder = selectedMethod.placeholder || '';
                input.inputMode = selectedMethod.inputMode || 'text';
            }
        };
        if (select) {
            select.addEventListener('change', updateInputForMethod);
            updateInputForMethod();
        }
    }

    function setupEventListeners() {
        navButtons.forEach(btn => btn.addEventListener('click', (e) => {
            const screenId = e.currentTarget.dataset.screen;
            showScreen(screenId);
            if (screenId === 'task-screen') {
                loadAndDisplayTasks();
            } else if (screenId === 'refer-screen') {
                updateUI();
            }
            // Re-create lucide icons if a new screen is shown
            setTimeout(lucide.createIcons, 100); 
        }));

        homeButtons.dailyCheckin.addEventListener('click', () => handleDailyCheckin(homeButtons.dailyCheckin));
        homeButtons.spin.addEventListener('click', () => showScreen('spin-screen'));
        homeButtons.quiz.addEventListener('click', startQuiz);

        spinScreenElements.backBtn.addEventListener('click', () => showScreen('home-screen'));
        quizScreenElements.backBtn.addEventListener('click', () => showScreen('home-screen'));
        spinScreenElements.triggerBtn.addEventListener('click', handleSpin);

        walletElements.submitBtn.addEventListener('click', () => handleSubmitWithdraw(walletElements.submitBtn));
        referElements.shareBtn.addEventListener('click', handleShareReferral);

        taskListContainer.addEventListener('click', handleTaskClick);
        quizScreenElements.optionsContainer.addEventListener('click', handleOptionSelect);
        quizScreenElements.nextBtn.addEventListener('click', handleNextQuiz);
    }

    function showScreen(screenId) {
        screens.forEach(s => s.classList.remove('active'));
        const activeScreen = document.getElementById(screenId);
        if (activeScreen) {
            activeScreen.classList.add('active');
        }
        navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.screen === screenId));
    }

    async function loadAndDisplayTasks() {
        taskListContainer.innerHTML = '<p class="text-gray-400">টাস্ক লোড হচ্ছে...</p>';
        try {
            const { data: tasks, error } = await sb.from('tasks').select('*').eq('isActive', true).order('createdAt', { ascending: false });
            if (error) throw error;
            if (tasks.length === 0) {
                taskListContainer.innerHTML = '<p class="text-gray-400">নতুন টাস্ক শীঘ্রই আসছে...</p>';
                return;
            }
            taskListContainer.innerHTML = '';
            const completedTasks = userData.completedTasks ?? [];
            tasks.forEach(task => {
                const isCompleted = completedTasks.includes(task.id);
                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${isCompleted ? 'completed' : ''}`;
                taskElement.dataset.taskId = task.id;
                taskElement.dataset.reward = task.reward;
                taskElement.innerHTML = `
                    <div class="task-item-header">
                        <h3 class="task-title">${task.title}</h3>
                        <span class="task-reward">৳ ${parseFloat(task.reward).toFixed(2)}</span>
                    </div>
                    <p class="task-description text-gray-400 text-sm mt-1">${task.description}</p>`;
                taskListContainer.appendChild(taskElement);
            });
        } catch (error) {
            handleError('টাস্ক লোড করতে সমস্যা হয়েছে।', error);
        }
    }

    async function handleTaskClick(e) {
        const taskItem = e.target.closest('.task-item');
        if (!taskItem || taskItem.classList.contains('completed')) {
            if (taskItem) tg.showAlert('আপনি এই টাস্কটি ইতোমধ্যে সম্পন্ন করেছেন।');
            return;
        }
        
        if (typeof window.showGiga !== 'function') {
            handleError("বিজ্ঞাপন ফাংশন (showGiga) পাওয়া যায়নি।");
            return;
        }

        const taskId = taskItem.dataset.taskId;
        const reward = parseFloat(taskItem.dataset.reward);
        tg.HapticFeedback.impactOccurred('light');

        try {
            await window.showGiga();
            tg.HapticFeedback.notificationOccurred('success');
            const updatedCompletedTasks = [...(userData.completedTasks ?? []), taskId];
            await awardEarnings(reward, { completedTasks: updatedCompletedTasks });
            
            tg.showAlert(`অভিনন্দন! টাস্ক সম্পন্ন করে ৳ ${reward.toFixed(2)} পেয়েছেন।`);
            taskItem.classList.add('completed');
        } catch (e) {
            handleError("বিজ্ঞাপন দেখাতে সমস্যা হয়েছে।", e);
        }
    }

    async function startQuiz() {
        try {
            const { data: freshUserData, error } = await sb.from('users').select('quizProgress').eq('id', telegramUser.id.toString()).single();
            if (error) throw new Error("ব্যবহারকারীর তথ্য পাওয়া যায়নি।");

            const today = new Date().toISOString().slice(0, 10);
            let currentQuizProgress = (freshUserData.quizProgress?.date === today)
                ? freshUserData.quizProgress
                : { date: today, completedToday: 0, currentStep: 0 };
            
            if (currentQuizProgress.completedToday >= quizConfig.dailyLimit) {
                tg.showAlert(`আপনি আজকের জন্য আপনার সব কুইজ সম্পন্ন করেছেন।`);
                return;
            }

            // রিসেট currentStep এবং DB তে আপডেট
            currentQuizProgress.currentStep = 0;
            const { error: updateError } = await sb.from('users').update({ quizProgress: currentQuizProgress }).eq('id', telegramUser.id.toString());
            if (updateError) throw updateError;

            userData.quizProgress = currentQuizProgress; // লোকাল ডেটা সিঙ্ক করুন

            showScreen('quiz-screen');
            quizScreenElements.questionText.textContent = 'প্রশ্ন লোড হচ্ছে...';
            quizScreenElements.optionsContainer.innerHTML = '';

            const { data: quizzes, error: quizError } = await sb.from('quizzes').select('*');
            if (quizError) throw quizError;
            if (quizzes.length === 0) throw new Error('কোনো কুইজ পাওয়া যায়নি।');

            quizQuestions = quizzes.sort(() => 0.5 - Math.random());
            currentQuizIndex = 0;
            displayCurrentQuiz();
        } catch (error) {
            handleError(error.message || 'কুইজ শুরু করতে একটি অপ্রত্যাশিত সমস্যা হয়েছে।', error);
            showScreen('home-screen');
        }
    }

    function displayCurrentQuiz() {
        if (!userData.quizProgress) return;
        
        const { completedToday = 0, currentStep = 0 } = userData.quizProgress;
        const remaining = quizConfig.dailyLimit - completedToday;
        quizScreenElements.progressText.textContent = `দৈনিক কুইজ সেশন বাকি আছে: ${remaining}`;
        
        const clickTarget = quizConfig.clickTarget || 3;
        quizScreenElements.stepText.textContent = `ধাপ: ${currentStep}/${clickTarget}`;
        quizScreenElements.progressInner.style.width = `${(currentStep / clickTarget) * 100}%`;

        if (currentQuizIndex >= quizQuestions.length) currentQuizIndex = 0;
        const quiz = quizQuestions[currentQuizIndex];
        
        if (!quiz) {
            handleError("কুইজের প্রশ্ন লোড করা যায়নি।");
            showScreen('home-screen');
            return;
        }

        quizScreenElements.questionText.textContent = quiz.question;
        quizScreenElements.optionsContainer.innerHTML = '';
        (quiz.options || []).forEach(optionText => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'quiz-option';
            optionDiv.textContent = optionText;
            quizScreenElements.optionsContainer.appendChild(optionDiv);
        });

        selectedQuizOption = null;
        quizScreenElements.nextBtn.disabled = true;

        if (currentStep === clickTarget - 1) {
            quizScreenElements.instruction.textContent = 'এটি শেষ ধাপ! পুরস্কার জিততে বিজ্ঞাপনে ক্লিক করুন।';
            quizScreenElements.nextBtn.textContent = 'Claim Reward';
        } else {
            quizScreenElements.instruction.textContent = 'সঠিক উত্তর দিয়ে পরবর্তী ধাপে যান';
            quizScreenElements.nextBtn.textContent = 'পরবর্তী কুইজ';
        }
    }

    function handleOptionSelect(e) {
        const option = e.target.closest('.quiz-option');
        if (!option) return;
        document.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        selectedQuizOption = option;
        quizScreenElements.nextBtn.disabled = false;
    }

    function handleNextQuiz() {
        if (!selectedQuizOption) return;
        if (selectedQuizOption.textContent !== quizQuestions[currentQuizIndex].correctAnswer) {
            tg.showAlert('ভুল উত্তর! অনুগ্রহ করে সঠিক উত্তরটি নির্বাচন করুন।');
            return;
        }
        
        if (typeof window.showGiga !== 'function') {
            handleError("বিজ্ঞাপন ফাংশন (showGiga) পাওয়া যায়নি।");
            return;
        }

        quizScreenElements.nextBtn.disabled = true;
        const currentStep = userData.quizProgress?.currentStep ?? 0;
        const clickTarget = quizConfig.clickTarget || 3;
        const isClaimStep = currentStep === clickTarget - 1;
        tg.HapticFeedback.impactOccurred('light');

        window.showGiga().then(() => {
            if (isClaimStep) {
                // --- অ্যাড ক্লিক টাস্ক (Claim) ---
                tg.HapticFeedback.notificationOccurred('success');
                // বিজ্ঞাপনে ক্লিক হয়েছে কিনা তা নিশ্চিত করার জন্য এটি একটি সহজ সিমুলেশন
                
                const updatedProgress = { 
                    date: new Date().toISOString().slice(0, 10),
                    completedToday: (userData.quizProgress.completedToday ?? 0) + 1, 
                    currentStep: 0 
                };
                
                awardEarnings(quizConfig.reward, { quizProgress: updatedProgress })
                .then(() => {
                    tg.showAlert(`অভিনন্দন! কুইজ সম্পন্ন করে ৳ ${quizConfig.reward.toFixed(2)} পেয়েছেন।`);
                    showScreen('home-screen');
                })
                .catch(e => {
                    handleError("পুরস্কার দিতে সমস্যা হয়েছে।", e);
                    quizScreenElements.nextBtn.disabled = false;
                });

            } else {
                // --- পরবর্তী ধাপ ---
                tg.HapticFeedback.notificationOccurred('success');
                const updatedProgress = { ...userData.quizProgress, currentStep: currentStep + 1 };
                sb.from('users').update({ quizProgress: updatedProgress }).eq('id', telegramUser.id.toString())
                  .then(({ error }) => {
                    if (error) throw error;
                    userData.quizProgress = updatedProgress; // লোকাল ডেটা সিঙ্ক করুন
                    currentQuizIndex++;
                    displayCurrentQuiz();
                  })
                  .catch(e => {
                      handleError("পরবর্তী ধাপে যেতে সমস্যা হয়েছে।", e);
                      quizScreenElements.nextBtn.disabled = false;
                  });
            }
        }).catch(e => {
            handleError("বিজ্ঞাপন দেখাতে সমস্যা হয়েছে।", e);
            quizScreenElements.nextBtn.disabled = false;
        });
    }

    function handleSpin() {
        if (isSpinning) return;

        const today = new Date().toISOString().slice(0, 10);
        const spinsTodayCount = userData.spinsToday?.date === today ? (userData.spinsToday?.count ?? 0) : 0;
        const spinsLeftCount = spinConfig.dailyLimit - spinsTodayCount;

        if (spinsLeftCount <= 0) {
            tg.showAlert("আপনার আজকের জন্য আর কোনো স্পিন বাকি নেই।");
            return;
        }
        
        if (typeof window.showGiga !== 'function') {
            handleError("বিজ্ঞাপন ফাংশন (showGiga) পাওয়া যায়নি।");
            return;
        }

        isSpinning = true;
        spinScreenElements.triggerBtn.disabled = true;
        tg.HapticFeedback.impactOccurred('light');

        window.showGiga().then(() => {
            tg.HapticFeedback.notificationOccurred('success');
            
            const numSegments = spinConfig.rewards.length;
            const targetSegment = Math.floor(Math.random() * numSegments);
            const segmentAngle = 360 / numSegments;
            const randomInSegment = (Math.random() * 0.8 + 0.1) * segmentAngle; 
            const targetRotation = (targetSegment * segmentAngle) + randomInSegment + (360 * 5); 

            spinScreenElements.wheelGroup.style.transform = `rotate(${targetRotation}deg)`;
            currentRotation = targetRotation % 360;

            setTimeout(() => spinFinished(targetSegment, today, spinsTodayCount), 5000);

        }).catch(e => {
            handleError("বিজ্ঞাপন দেখাতে সমস্যা হয়েছে।", e);
            isSpinning = false;
            spinScreenElements.triggerBtn.disabled = false;
        });
    }

    async function spinFinished(targetSegment, today, spinsTodayCount) {
        try {
            const reward = spinConfig.rewards[targetSegment];
            await awardEarnings(reward, {
                spinsToday: { date: today, count: spinsTodayCount + 1 }
            });
            tg.showAlert(`অভিনন্দন! স্পিন থেকে ৳ ${reward.toFixed(2)} পেয়েছেন।`);
        } catch (e) {
            handleError("স্পিনের পুরস্কার দিতে সমস্যা হয়েছে।", e);
        } finally {
            isSpinning = false;
            spinScreenElements.triggerBtn.disabled = false;
            
            // স্পিন অ্যানিমেশন রিসেট করুন
            spinScreenElements.wheelGroup.style.transition = 'none';
            spinScreenElements.wheelGroup.style.transform = `rotate(${currentRotation}deg)`;
            setTimeout(() => {
                spinScreenElements.wheelGroup.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
            }, 50);
        }
    }

    async function handleDailyCheckin(buttonElement) {
        const today = new Date().toISOString().slice(0, 10);
        const checkinsTodayCount = userData.checkinsToday?.date === today ? (userData.checkinsToday?.count ?? 0) : 0;
        
        if (checkinsTodayCount >= appConfig.dailyCheckinLimit) {
            tg.showAlert("আপনি আজকের জন্য আপনার সব Daily Check সম্পন্ন করেছেন।");
            return;
        }
        
        if (typeof window.showGiga !== 'function') {
            handleError("বিজ্ঞাপন ফাংশন (showGiga) পাওয়া যায়নি।");
            return;
        }

        buttonElement.disabled = true;
        tg.HapticFeedback.impactOccurred('light');

        try {
            await window.showGiga();
            tg.HapticFeedback.notificationOccurred('success');
            await awardEarnings(appConfig.dailyReward, {
                checkinsToday: { date: today, count: checkinsTodayCount + 1 }
            });
            tg.showAlert(`অভিনন্দন! Daily Check বোনাস হিসেবে ৳ ${appConfig.dailyReward.toFixed(2)} পেয়েছেন।`);
        } catch (e) {
            handleError("বিজ্ঞাপন দেখাতে সমস্যা হয়েছে।", e);
        } finally {
            buttonElement.disabled = false;
        }
    }

    async function handleSubmitWithdraw(buttonElement) {
        const methodSelect = document.getElementById('paymentMethodSelect');
        const accountNumberInput = document.getElementById('accountNumberInput');
        if (!methodSelect || !accountNumberInput) {
            handleError("পেমেন্ট ফর্ম সঠিকভাবে লোড হয়নি।");
            return;
        }

        const selectedMethod = paymentMethods.find(m => m.id === methodSelect.value);
        const accountNumber = accountNumberInput.value.trim();

        if (!selectedMethod) {
            tg.showAlert("অনুগ্রহ করে একটি বৈধ পেমেন্ট পদ্ধতি নির্বাচন করুন।");
            return;
        }
        if (accountNumber.length < (selectedMethod.minLength || 1) || !/^\d+$/.test(accountNumber)) {
            tg.showAlert(`অনুগ্রহ করে একটি সঠিক ${selectedMethod.name} নম্বর দিন।`);
            return;
        }
        if ((userData.balance ?? 0) < MINIMUM_WITHDRAW_AMOUNT) {
            tg.showAlert(`আপনার অ্যাকাউন্টে পর্যাপ্ত ব্যালেন্স নেই।`);
            return;
        }

        buttonElement.disabled = true;
        const withdrawalAmount = userData.balance ?? 0;

        const withdrawal = {
            userId: telegramUser.id.toString(),
            username: telegramUser.username || '',
            amount: withdrawalAmount,
            methodId: selectedMethod.id,
            methodName: selectedMethod.name,
            accountNumber: accountNumber,
            timestamp: new Date().toISOString()
        };

        try {
            // RLS-এর কারণে এই আপডেটগুলো RPC (বা Edge Function) দিয়ে করাই ভালো।
            // কিন্তু যেহেতু সার্ভার ফাংশন এখানে তৈরি করা নেই, তাই দুটি ধাপে ক্লায়েন্ট আপডেট করা হলো।
            
            // 1. ব্যালেন্স 0 করুন
            const { error: updateError } = await sb.from('users').update({ balance: 0 }).eq('id', telegramUser.id.toString());
            if (updateError) throw updateError;
            
            // 2. উইথড্রল রিকোয়েস্ট পাঠান
            const { error: insertError } = await sb.from('withdrawals').insert(withdrawal);
            if (insertError) {
                // যদি উইথড্রল রিকোয়েস্ট ফেইল হয়, ব্যালেন্স ফেরত দিন
                await sb.from('users').update({ balance: withdrawalAmount }).eq('id', telegramUser.id.toString());
                throw insertError;
            }

            tg.showAlert("আপনার উইথড্র অনুরোধ সফলভাবে জমা হয়েছে।");
            showScreen('home-screen');
            accountNumberInput.value = '';
        } catch (e) {
            handleError("উইথড্র অনুরোধে সমস্যা হয়েছে।", e);
            buttonElement.disabled = false;
        }
    }

    function handleShareReferral() {
        const link = referElements.linkInput.value;
        const text = `এখানে প্রতিদিন আয় করুন! আমার অ্যাফিলিয়েট লিংক দিয়ে জয়েন করুন: ${link}`;
        tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`);
    }

    function handleError(message, error) {
        if (error) console.error("Error Details:", error);
        tg.showAlert(typeof message === 'string' ? message : "একটি অপ্রত্যাশিত সমস্যা হয়েছে।");
    }

    function getInitials(fullName) {
        if (!fullName) return '?';
        const names = fullName.split(' ').filter(Boolean); 
        if (names.length === 0) return '?';
        const firstInitial = names[0][0] || '';
        const lastInitial = names.length > 1 ? names[names.length - 1][0] : '';
        return `${firstInitial}${lastInitial}`.toUpperCase();
    }

    function createSvgWheel() {
        const wheelGroup = spinScreenElements.wheelGroup;
        if (!wheelGroup) return;
        wheelGroup.innerHTML = '';
        const numSegments = spinConfig.rewards.length;
        if (numSegments === 0) return; 

        const angle = 360 / numSegments;
        const colors = ['#e53935', '#1e88e5', '#43a047', '#fdd835', '#8e24aa', '#d81b60', '#00acc1', '#fb8c00', '#5e35b1', '#6d4c41'];
        const polarToCartesian = (centerX, centerY, radius, angleInDegrees) => {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return { x: centerX + (radius * Math.cos(angleInRadians)), y: centerY + (radius * Math.sin(angleInRadians)) };
        };

        for (let i = 0; i < numSegments; i++) {
            const startAngle = i * angle;
            const endAngle = startAngle + angle;
            const start = polarToCartesian(250, 250, 210, endAngle);
            const end = polarToCartesian(250, 250, 210, startAngle);
            const largeArcFlag = angle > 180 ? "1" : "0";
            const pathData = `M 250 250 L ${start.x} ${start.y} A 210 210 0 ${largeArcFlag} 0 ${end.x} ${end.y} z`;
            
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", pathData);
            path.setAttribute("fill", colors[i % colors.length]); 
            path.setAttribute("stroke", "#8d6e63");
            path.setAttribute("stroke-width", "4");
            wheelGroup.appendChild(path);

            const textAngle = startAngle + (angle / 2);
            const textPos = polarToCartesian(250, 250, 150, textAngle);
            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", textPos.x);
            text.setAttribute("y", textPos.y);
            text.setAttribute("fill", "white");
            text.setAttribute("font-size", "20");
            text.setAttribute("font-weight", "bold");
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("dominant-baseline", "middle");
            text.setAttribute("transform", `rotate(${textAngle + 90}, ${textPos.x}, ${textPos.y})`);
            text.textContent = `৳${spinConfig.rewards[i].toFixed(1)}`;
            wheelGroup.appendChild(text);
        }
        // Center circle
        const center = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        center.setAttribute("cx", "250");
        center.setAttribute("cy", "250");
        center.setAttribute("r", "20");
        center.setAttribute("fill", "#5d4037");
        wheelGroup.appendChild(center);
    }

    function generateUniqueAffiliateCode(base) {
        const randomPart = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        const cleanBase = base.replace(/[^a-zA-Z0-9]/g, ''); 
        return cleanBase.slice(0, 8).toUpperCase() + randomPart;
    }

    async function handleAffiliateSignup(affiliateCode, newUserId) {
        // RLS এর কারণে রেফারারকে বোনাস দেওয়ার কাজটি সার্ভার সাইডে (Edge Function/RPC) করাই নিরাপদ।
        // যেহেতু RPC তৈরি করা নেই, তাই এটি এখন শুধুমাত্র ক্লায়েন্ট সাইডেই চেষ্টা করবে।
        try {
            const { data: referrer, error } = await sb.from('users').select('id, balance, referrals, referralEarnings').eq('affiliateCode', affiliateCode).single();
            if (error || !referrer) {
                if(error) console.error("Referrer fetch error:", error);
                return;
            }
            if (!referrer.referrals || !referrer.referrals.includes(newUserId)) {
                const bonus = appConfig.referralBonus ?? 0;
                await sb.from('users').update({
                    balance: (referrer.balance ?? 0) + bonus,
                    referrals: [...(referrer.referrals ?? []), newUserId],
                    referralEarnings: (referrer.referralEarnings ?? 0) + bonus
                }).eq('id', referrer.id); // **NOTE: RLS will likely block this.**
            }
        } catch (error) {
            console.error("Affiliate signup handling failed (RLS likely blocked):", error);
        }
    }

    async function awardEarnings(amount, additionalUpdates = {}) {
        if (!userData || !userData.id) {
            throw new Error("User data not available for awarding earnings.");
        }

        const currentUserId = userData.id;
        const newBalance = (userData.balance ?? 0) + amount;
        
        // 1. নিজের ব্যালেন্স আপডেট করুন (RLS Allowed)
        const { error: selfUpdateError } = await sb.from('users').update({
            balance: newBalance,
            ...additionalUpdates
        }).eq('id', currentUserId);
        
        if (selfUpdateError) throw selfUpdateError;

        // লোকাল ডেটা আপডেট করুন
        userData = { ...userData, balance: newBalance, ...additionalUpdates };
        updateUI(); 

        // 2. অ্যাফিলিয়েট কমিশন গণনা এবং দেওয়ার চেষ্টা করুন (RLS Blocked-If-No-RPC)
        if (userData.referredBy && (appConfig.affiliateCommissionRate ?? 0) > 0) {
            try {
                let commissionAmount = amount * appConfig.affiliateCommissionRate;

                // **ATTENTION**: This update will likely FAIL due to RLS, as a user
                // cannot update another user's balance from the client side.
                // A secure RPC is REQUIRED here.
                const { error: commissionError } = await sb.from('users').update({
                    balance: sb.rpc('increment_balance', { amount: commissionAmount }), // Placeholder for potential RPC call
                    referralEarnings: sb.rpc('increment_balance', { amount: commissionAmount }) // Placeholder
                }).eq('id', userData.referredBy);

                if (commissionError) {
                    console.warn("Affiliate commission update failed on client (Expected RLS block). You need an RPC function for this.", commissionError);
                }
            } catch (e) {
                console.error("Affiliate commission client-side processing error:", e);
            }
        }
    }

    // --- App Start ---
    window.onload = function() {
        main();
    };

    // --- Re-create icons on load to ensure they show up ---
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
    }

</script>
</body>
</html>
