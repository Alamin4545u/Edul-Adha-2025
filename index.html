<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EdChess - The Grandmaster</title>
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- GIGAPUB SCRIPT PLACEHOLDER -->
<!-- <script src="https://gigapub.com/sdk.js"></script> -->

<!-- Tailwind Config for Custom Colors -->
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    gold: '#FFD700',
                    royal: '#C5A059',
                    glass: 'rgba(255, 255, 255, 0.05)',
                    darkbg: '#050505',
                    navbg: 'rgba(10, 10, 10, 0.8)'
                },
                fontFamily: {
                    cinzel: ['Cinzel', 'serif'],
                    inter: ['Inter', 'sans-serif'],
                },
                animation: {
                    'float': 'float 3s ease-in-out infinite',
                    'pulse-gold': 'pulseGold 2s infinite',
                    'spin-slow': 'spin 12s linear infinite',
                    'slide-up': 'slideUp 0.3s ease-out',
                },
                keyframes: {
                    float: {
                        '0%, 100%': { transform: 'translateY(0)' },
                        '50%': { transform: 'translateY(-10px)' },
                    },
                    pulseGold: {
                        '0%, 100%': { boxShadow: '0 0 10px rgba(255, 215, 0, 0.2)' },
                        '50%': { boxShadow: '0 0 25px rgba(255, 215, 0, 0.5)' },
                    },
                    slideUp: {
                        '0%': { transform: 'translateY(100%)', opacity: '0' },
                        '100%': { transform: 'translateY(0)', opacity: '1' },
                    }
                }
            }
        }
    }
</script>

<style>
    body {
        background-color: #050505;
        background-image: radial-gradient(circle at 50% 0%, #1a1500 0%, #050505 70%);
        color: #e5e5e5;
        -webkit-tap-highlight-color: transparent;
        overflow: hidden; /* Prevent scrolling on body, handle per page */
    }
    
    /* Glassmorphism Utilities */
    .glass-panel {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    }

    .glass-nav {
        background: rgba(5, 5, 5, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-gold {
        background: linear-gradient(135deg, #C5A059 0%, #FFD700 100%);
        color: #000;
        font-weight: 700;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        transition: transform 0.1s, box-shadow 0.2s;
    }
    .btn-gold:active {
        transform: scale(0.96);
        box-shadow: 0 0 5px rgba(255, 215, 0, 0.2);
    }

    /* Custom Scrollbar */
    .scroller {
        overflow-y: auto;
        height: 100%;
        padding-bottom: 100px; /* Space for navbar */
    }
    .scroller::-webkit-scrollbar {
        width: 4px;
    }
    .scroller::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }

    /* 3D Chess Button */
    .chess-btn-container {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(197, 160, 89, 0.1) 0%, rgba(0,0,0,0) 70%);
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(255, 215, 0, 0.1);
    }

    .chess-btn {
        font-size: 80px;
        cursor: pointer;
        filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.4));
        transition: transform 0.1s;
        user-select: none;
    }
    .chess-btn:active {
        transform: scale(0.9) rotate(-5deg);
    }

    /* Loader */
    .loader {
        border: 3px solid rgba(255, 215, 0, 0.1);
        border-top: 3px solid #FFD700;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    /* Circular Progress for Cooldown */
    .circular-chart {
        display: block;
        margin: 0 auto;
        max-width: 100%;
        max-height: 250px;
    }
    .circle-bg {
        fill: none;
        stroke: rgba(255,255,255,0.05);
        stroke-width: 2.5;
    }
    .circle {
        fill: none;
        stroke-width: 2.5;
        stroke-linecap: round;
        stroke: #FFD700;
        transition: stroke-dasharray 1s linear;
    }
</style>
</head>
<body class="font-inter">
<!-- 
=============================================
üî• SUPABASE SQL SETUP (Run in SQL Editor)
=============================================

-- TABLE users
create table public.users (
  id bigint primary key, 
  username text, 
  balance numeric default 0, 
  rank text default 'Pawn', 
  created_at timestamptz default now()
);

-- TABLE transactions
create table public.transactions (
  id uuid primary key default gen_random_uuid(), 
  user_id bigint references public.users(id), 
  amount numeric, 
  type text, 
  status text default 'pending',
  created_at timestamptz default now()
);

-- RPC FUNCTION increment_balance
create or replace function increment_balance(user_id bigint, amount numeric)
returns void as $$
begin
  update public.users 
  set balance = balance + amount 
  where id = user_id;
end;
$$ language plpgsql;
-->

<!-- APP WRAPPER -->
<div id="app" class="relative h-screen w-full flex flex-col">
    
    <!-- HEADER (Shared) -->
    <header class="flex justify-between items-center p-5 z-20">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-royal to-black border border-royal/30 flex items-center justify-center text-gold font-bold text-lg">
                <span id="rank-icon">‚ôüÔ∏è</span>
            </div>
            <div>
                <h1 id="username-display" class="font-cinzel font-bold text-white text-lg leading-tight">Player</h1>
                <p id="rank-display" class="text-xs text-royal uppercase tracking-widest">Pawn</p>
            </div>
        </div>
        <div class="glass-panel px-4 py-1.5 rounded-full flex items-center gap-2">
            <span class="text-gold text-lg">‚õÉ</span>
            <span id="balance-display" class="font-mono text-white font-bold">0.00</span>
        </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-1 relative overflow-hidden">
        
        <!-- 1. HOME SCREEN -->
        <section id="home-page" class="page-section absolute inset-0 scroller px-5 pt-4">
            
            <div class="text-center mb-6 mt-4">
                <h2 class="font-cinzel text-2xl text-transparent bg-clip-text bg-gradient-to-r from-white via-royal to-white opacity-90">Checkmate Earnings</h2>
                <p class="text-white/40 text-xs mt-1">Tap the King &bull; Watch Strategy &bull; Earn Gold</p>
            </div>

            <!-- 3D King Button & Cooldown -->
            <div class="relative flex flex-col items-center justify-center py-10">
                <!-- Progress Circle Layer -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-50">
                    <svg viewBox="0 0 36 36" class="circular-chart w-64 h-64">
                        <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path id="cooldown-circle" class="circle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                </div>

                <!-- Button -->
                <div class="chess-btn-container animate-float">
                    <div id="king-btn" class="chess-btn" onclick="handleKingTap()">
                        ‚ôö
                    </div>
                </div>
            </div>

            <div class="text-center mt-2">
                <p id="status-text" class="text-royal/80 text-sm font-cinzel">Your Move, Grandmaster.</p>
            </div>

            <!-- Recent Activity (Visual Only) -->
            <div class="mt-12 glass-panel rounded-xl p-4">
                <h3 class="font-cinzel text-white/70 text-sm mb-3 border-b border-white/5 pb-2">Battle Log</h3>
                <div class="space-y-3">
                    <div class="flex justify-between text-xs">
                        <span class="text-white/50">Opening Gambit Reward</span>
                        <span class="text-gold">+50 ‚õÉ</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-white/50">Daily Login</span>
                        <span class="text-gold">+10 ‚õÉ</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. TASKS PAGE -->
        <section id="tasks-page" class="page-section absolute inset-0 scroller px-5 pt-4 hidden">
            <h2 class="font-cinzel text-2xl text-center mb-6">Strategy Moves</h2>
            
            <div class="space-y-4">
                <!-- Task Item -->
                <div class="glass-panel p-4 rounded-xl flex items-center gap-4 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-royal/10 to-transparent opacity-0 group-hover:opacity-100 transition"></div>
                    <div class="text-3xl">üì¢</div>
                    <div class="flex-1">
                        <h4 class="text-white font-bold text-sm">Join Announcements</h4>
                        <p class="text-white/40 text-xs">Subscribe to our channel</p>
                    </div>
                    <button class="px-3 py-1.5 rounded-lg border border-royal text-royal text-xs font-bold hover:bg-royal hover:text-black transition" onclick="completeTask(this, 100)">
                        +100 ‚õÉ
                    </button>
                </div>

                <div class="glass-panel p-4 rounded-xl flex items-center gap-4">
                    <div class="text-3xl">üê¶</div>
                    <div class="flex-1">
                        <h4 class="text-white font-bold text-sm">Follow X (Twitter)</h4>
                        <p class="text-white/40 text-xs">Like & Retweet Pinned</p>
                    </div>
                    <button class="px-3 py-1.5 rounded-lg border border-royal text-royal text-xs font-bold hover:bg-royal hover:text-black transition" onclick="completeTask(this, 150)">
                        +150 ‚õÉ
                    </button>
                </div>

                <div class="glass-panel p-4 rounded-xl flex items-center gap-4">
                    <div class="text-3xl">üë•</div>
                    <div class="flex-1">
                        <h4 class="text-white font-bold text-sm">Invite a Pawn</h4>
                        <p class="text-white/40 text-xs">Refer a friend</p>
                    </div>
                    <button class="px-3 py-1.5 rounded-lg border border-royal text-royal text-xs font-bold hover:bg-royal hover:text-black transition" onclick="completeTask(this, 500)">
                        +500 ‚õÉ
                    </button>
                </div>
            </div>
        </section>

        <!-- 3. LEADERBOARD PAGE -->
        <section id="leaderboard-page" class="page-section absolute inset-0 scroller px-5 pt-4 hidden">
            <h2 class="font-cinzel text-2xl text-center mb-2">Hall of Masters</h2>
            <p class="text-center text-white/40 text-xs mb-6">Top 50 Players by Gold</p>

            <div class="glass-panel rounded-2xl overflow-hidden">
                <div class="flex bg-white/5 p-3 text-xs text-white/50 font-bold uppercase tracking-wider">
                    <div class="w-10 text-center">#</div>
                    <div class="flex-1 pl-2">Player</div>
                    <div class="text-right">Balance</div>
                </div>
                <div id="leaderboard-list" class="divide-y divide-white/5">
                    <!-- Populated by JS -->
                    <div class="p-8 text-center text-white/30 text-xs">Loading rankings...</div>
                </div>
            </div>
        </section>

        <!-- 4. WALLET PAGE -->
        <section id="wallet-page" class="page-section absolute inset-0 scroller px-5 pt-4 hidden">
            
            <div class="glass-panel rounded-2xl p-6 text-center mb-8 relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-royal/20 blur-3xl rounded-full"></div>
                <div class="relative z-10">
                    <p class="text-white/60 text-sm font-cinzel mb-2">Total Treasury</p>
                    <h2 id="wallet-balance" class="text-4xl font-bold text-gold font-mono mb-4">0.00</h2>
                    <div class="flex justify-center gap-2">
                        <span class="px-2 py-1 bg-white/10 rounded text-[10px] text-white/70">1000 ‚õÉ = $0.10</span>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-xl p-5">
                <h3 class="font-cinzel text-white mb-4">Claim Prize</h3>
                
                <div class="mb-4">
                    <label class="block text-xs text-white/50 mb-2">Select Method</label>
                    <div class="flex gap-2">
                        <button class="flex-1 py-2 rounded border border-white/10 bg-white/5 text-sm hover:border-royal focus:border-royal transition">USDT (TRC20)</button>
                        <button class="flex-1 py-2 rounded border border-white/10 bg-white/5 text-sm hover:border-royal focus:border-royal transition">TON</button>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-xs text-white/50 mb-2">Wallet Address</label>
                    <input type="text" id="withdraw-address" placeholder="Enter address..." class="w-full bg-black/50 border border-white/10 rounded p-3 text-white text-sm focus:outline-none focus:border-royal transition">
                </div>

                <button onclick="submitWithdrawal()" class="w-full btn-gold py-3 rounded-lg text-sm uppercase tracking-wide">
                    Request Withdrawal
                </button>
            </div>
        </section>

    </main>

    <!-- NAVIGATION BAR -->
    <nav class="glass-nav h-[80px] w-full z-30 flex justify-around items-center px-2 pb-2">
        
        <button class="nav-btn active flex flex-col items-center gap-1 p-2 w-16 text-royal transition-all duration-300" onclick="switchPage('home')">
            <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24"><path d="M5,20H19V22H5V20M17,17V19H7V17H17M15,10H19V12H17V16H15V12H13V16H11V12H9V16H7V12H5V10H9V7H7V5H9V3H11V5H13V3H15V5H17V7H15V10M11,7V10H13V7H11Z" /></svg>
            <span class="text-[10px] font-medium opacity-80">Home</span>
        </button>

        <button class="nav-btn flex flex-col items-center gap-1 p-2 w-16 text-white/40 hover:text-white transition-all duration-300" onclick="switchPage('tasks')">
            <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24"><path d="M19,20H5V22H19V20M12,2A1,1 0 0,1 13,3V5.18L17.6,18H6.4L11,5.18V3A1,1 0 0,1 12,2M12,18L10.22,13H13.78L12,18M11,7.82L9.22,12H14.78L13,7.82V7H11V7.82Z" /></svg>
            <span class="text-[10px] font-medium opacity-80">Tasks</span>
        </button>

        <button class="nav-btn flex flex-col items-center gap-1 p-2 w-16 text-white/40 hover:text-white transition-all duration-300" onclick="switchPage('leaderboard')">
            <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24"><path d="M18,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V4A2,2 0 0,0 18,2M18,20H6V4H18V20M8,12V18H10V12H8M12,8V18H14V8H12M16,14V18H18V14H16Z" /></svg>
            <span class="text-[10px] font-medium opacity-80">Rank</span>
        </button>

        <button class="nav-btn flex flex-col items-center gap-1 p-2 w-16 text-white/40 hover:text-white transition-all duration-300" onclick="switchPage('wallet')">
            <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24"><path d="M5,20H19V22H5V20M12,2C12,2 7,4 7,8V10H5V12H7V15H9V12H11V15H13V12H15V15H17V12H19V10H17V8C17,4 12,2 12,2M12,5C12.83,5 13.5,5.67 13.5,6.5C13.5,7.33 12.83,8 12,8C11.17,8 10.5,7.33 10.5,6.5C10.5,5.67 11.17,5 12,5Z" /></svg>
            <span class="text-[10px] font-medium opacity-80">Wallet</span>
        </button>

    </nav>

    <!-- REWARD MODAL -->
    <div id="reward-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="glass-panel w-[80%] max-w-sm rounded-2xl p-6 text-center transform scale-90 transition-transform duration-300" id="reward-content">
            <div class="text-6xl mb-4 animate-bounce">üèÜ</div>
            <h3 class="text-2xl font-cinzel text-gold mb-2">Victory!</h3>
            <p class="text-white/70 mb-6">You outsmarted the opponent.</p>
            <div class="text-4xl font-bold text-white mb-6 flex justify-center items-center gap-2">
                <span class="text-gold">+</span><span id="reward-amount">100</span> <span class="text-xl">‚õÉ</span>
            </div>
            <button onclick="closeRewardModal()" class="w-full btn-gold py-3 rounded-lg font-bold">Collect Loot</button>
        </div>
    </div>

</div>

<!-- MAIN JAVASCRIPT -->
<script>
    // CONFIGURATION
    // REPLACE THESE WITH YOUR SUPABASE DETAILS
    const SUPABASE_URL = 'https://uqyhgzhesvlvclszkkkm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxeWhnemhlc3ZsdmNsc3pra2ttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMTIxNzYsImV4cCI6MjA3OTY4ODE3Nn0.X9sZ8V6fOcMbXWnbkMonT-gE1xH-TEDur3Aa7aEGjDc';

    // STATE
    let user = null;
    let balance = 0;
    let isCooldown = false;
    const adDuration = 3000; // Simulated ad time
    const cooldownTime = 10000; // 10 seconds between moves

    // INIT CLIENTS
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const tg = window.Telegram.WebApp;

    // ------------------------------------------------------------------
    // CORE FUNCTIONS
    // ------------------------------------------------------------------

    async function initApp() {
        tg.expand();
        tg.ready();

        // Handle Dark Mode
        if (tg.colorScheme === 'dark') {
            document.documentElement.classList.add('dark');
        }

        // Mock Telegram Data if testing locally outside Telegram
        const initData = tg.initDataUnsafe?.user || {
            id: 123456789,
            username: "Grandmaster_Test",
            first_name: "Test"
        };

        // Auth / Fetch User
        await authenticateUser(initData);
    }

    async function authenticateUser(tgUser) {
        // Upsert User
        const { data, error } = await sb
            .from('users')
            .select('*')
            .eq('id', tgUser.id)
            .single();

        if (!data) {
            // Create new user
            const { error: insertError } = await sb
                .from('users')
                .insert([{ 
                    id: tgUser.id, 
                    username: tgUser.username || tgUser.first_name,
                    balance: 0,
                    rank: 'Pawn'
                }]);
            
            if (!insertError) {
                user = { id: tgUser.id, username: tgUser.username, balance: 0, rank: 'Pawn' };
            }
        } else {
            user = data;
            balance = parseFloat(data.balance);
        }

        updateUI();
    }

    function updateUI() {
        if (!user) return;
        
        // Update Text
        document.getElementById('username-display').innerText = user.username;
        document.getElementById('balance-display').innerText = balance.toFixed(2);
        document.getElementById('wallet-balance').innerText = balance.toFixed(2);
        
        // Calculate Rank
        let rank = 'Pawn';
        let icon = '‚ôüÔ∏è';
        if (balance >= 5000) { rank = 'Grandmaster'; icon = 'üëë'; }
        else if (balance >= 1000) { rank = 'Knight'; icon = '‚ôû'; }

        document.getElementById('rank-display').innerText = rank;
        document.getElementById('rank-icon').innerText = icon;
        
        // Sync with DB if rank changed (optimistic)
        if (rank !== user.rank) {
            user.rank = rank;
            sb.from('users').update({ rank: rank }).eq('id', user.id).then();
        }
    }

    // ------------------------------------------------------------------
    // GAMEPLAY & ADS
    // ------------------------------------------------------------------

    function handleKingTap() {
        if (isCooldown) return;
        
        // Simulate Ad Trigger
        showAd().then(() => {
            // Ad Closed, Reward User
            const reward = Math.floor(Math.random() * 50) + 10;
            claimReward(reward);
        }).catch(e => console.error(e));
    }

    function showAd() {
        return new Promise((resolve) => {
            // Show loading/ad text
            const status = document.getElementById('status-text');
            const btn = document.getElementById('king-btn');
            
            status.innerText = "Analyzing Opponent Strategy... (Ad)";
            btn.style.transform = "scale(0.8)";
            btn.innerText = "‚è≥";
            
            // Simulate Ad Duration
            setTimeout(() => {
                btn.style.transform = "scale(1)";
                btn.innerText = "‚ôö";
                status.innerText = "Strategy Found!";
                resolve(true);
            }, adDuration);
        });
    }

    async function claimReward(amount) {
        // Show Popup
        const modal = document.getElementById('reward-modal');
        const content = document.getElementById('reward-content');
        document.getElementById('reward-amount').innerText = amount;
        
        modal.classList.remove('hidden');
        // Small delay for CSS transition
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-90');
            content.classList.add('scale-100');
        }, 50);

        // DB Update
        const { error } = await sb.rpc('increment_balance', { 
            user_id: user.id, 
            amount: amount 
        });

        if (!error) {
            balance += amount;
            updateUI();
        }

        startCooldown();
    }

    function closeRewardModal() {
        const modal = document.getElementById('reward-modal');
        const content = document.getElementById('reward-content');
        
        modal.classList.add('opacity-0');
        content.classList.remove('scale-100');
        content.classList.add('scale-90');
        
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    function startCooldown() {
        isCooldown = true;
        const circle = document.getElementById('cooldown-circle');
        const status = document.getElementById('status-text');
        const btn = document.getElementById('king-btn');

        status.innerText = "Resting pieces...";
        btn.classList.add('opacity-50', 'cursor-not-allowed');

        // Animate Circle (Stroke Dashoffset)
        // Circumference ~ 100
        circle.style.strokeDasharray = "100, 100";
        circle.style.transition = `stroke-dasharray ${cooldownTime}ms linear`;
        
        // Trigger reflow
        void circle.offsetWidth;
        
        circle.style.strokeDasharray = "0, 100";

        setTimeout(() => {
            isCooldown = false;
            circle.style.transition = 'none';
            circle.style.strokeDasharray = "0, 100"; // Reset
            status.innerText = "Your Move, Grandmaster.";
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }, cooldownTime);
    }

    // ------------------------------------------------------------------
    // TASKS
    // ------------------------------------------------------------------
    
    function completeTask(btn, amount) {
        if (btn.innerText === "Claimed") return;

        btn.innerHTML = `<div class="loader w-4 h-4 border-2"></div>`;
        
        // Simulate API call check
        setTimeout(async () => {
            const { error } = await sb.rpc('increment_balance', { 
                user_id: user.id, 
                amount: amount 
            });

            if(!error) {
                balance += amount;
                updateUI();
                btn.innerText = "Claimed";
                btn.classList.remove('border-royal', 'text-royal', 'hover:bg-royal');
                btn.classList.add('bg-green-500/20', 'text-green-400', 'border-transparent', 'cursor-default');
                btn.onclick = null;
            }
        }, 1500);
    }

    // ------------------------------------------------------------------
    // LEADERBOARD
    // ------------------------------------------------------------------

    async function fetchLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = `<div class="p-8 text-center text-white/30 text-xs"><div class="loader mx-auto mb-2"></div>Fetching data...</div>`;

        const { data, error } = await sb
            .from('users')
            .select('username, balance')
            .order('balance', { ascending: false })
            .limit(50);

        if (data) {
            let html = '';
            data.forEach((u, index) => {
                const isMe = u.username === user.username ? 'bg-royal/20' : '';
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`;
                
                html += `
                    <div class="flex items-center p-3 text-sm ${isMe}">
                        <div class="w-10 text-center font-bold text-gold">${medal}</div>
                        <div class="flex-1 pl-2 text-white font-medium truncate">${u.username}</div>
                        <div class="text-right text-gold font-mono">${parseFloat(u.balance).toFixed(0)}</div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }
    }

    // ------------------------------------------------------------------
    // WALLET
    // ------------------------------------------------------------------

    async function submitWithdrawal() {
        const addr = document.getElementById('withdraw-address').value;
        if (addr.length < 5) {
            alert("Please enter a valid address.");
            return;
        }
        
        if (balance < 1000) {
            alert("Minimum withdrawal is 1000 Coins.");
            return;
        }

        const { error } = await sb.from('transactions').insert([{
            user_id: user.id,
            amount: balance,
            type: 'withdrawal',
            status: 'pending'
        }]);

        if (!error) {
            alert("Withdrawal request sent!");
            // Optionally deduct balance immediately or wait for approval
            // For this demo, we keep balance but log transaction
            document.getElementById('withdraw-address').value = '';
        } else {
            alert("Error processing request.");
        }
    }

    // ------------------------------------------------------------------
    // NAVIGATION
    // ------------------------------------------------------------------

    function switchPage(pageId) {
        // Update Active Icon
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('text-royal', 'active');
            btn.classList.add('text-white/40');
        });
        event.currentTarget.classList.remove('text-white/40');
        event.currentTarget.classList.add('text-royal', 'active');

        // Hide all pages
        document.querySelectorAll('.page-section').forEach(sec => {
            sec.classList.add('hidden');
            sec.classList.remove('animate-slide-up');
        });

        // Show target page
        const target = document.getElementById(`${pageId}-page`);
        target.classList.remove('hidden');
        target.classList.add('animate-slide-up');

        // Load data if needed
        if (pageId === 'leaderboard') fetchLeaderboard();
    }

    // START
    window.onload = initApp;

</script>
</body>
</html>
